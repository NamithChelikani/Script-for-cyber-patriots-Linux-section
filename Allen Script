#!/bin/bash

#################################################################
# Interactive Linux Security Hardening Script
# Always review actions before confirming
#################################################################

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}Please run as root (use sudo)${NC}"
    exit 1
fi

# Logging
LOG_FILE="/var/log/security_hardening_$(date +%Y%m%d_%H%M%S).log"
echo "Security Hardening Script Started - $(date)" | tee -a "$LOG_FILE"

# Function to log actions
log_action() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Function to pause
pause() {
    echo ""
    read -p "Press Enter to continue..."
}

# Function to ask yes/no
ask_yes_no() {
    while true; do
        read -p "$1 (y/n): " yn
        case $yn in
            [Yy]* ) return 0;;
            [Nn]* ) return 1;;
            * ) echo "Please answer yes or no.";;
        esac
    done
}

#################################################################
# MAIN MENU
#################################################################
show_menu() {
    clear
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}   Linux Security Hardening Script${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    echo -e "${YELLOW}WARNING: Use on test systems only!${NC}"
    echo ""
    echo "1)  Update System"
    echo "2)  User Management"
    echo "3)  Password Policies"
    echo "4)  Service Management"
    echo "5)  Firewall Configuration"
    echo "6)  SSH Hardening"
    echo "7)  File Permissions & Audit"
    echo "8)  Find Prohibited Files"
    echo "9)  Remove Common Hacking Tools"
    echo "10) Kernel Security (sysctl)"
    echo "11) Install Security Tools"
    echo "12) System Audit Report"
    echo "13) Run ALL (Interactive)"
    echo "0)  Exit"
    echo ""
    echo -e "Log file: ${GREEN}$LOG_FILE${NC}"
    echo ""
}

#################################################################
# 1. UPDATE SYSTEM
#################################################################
update_system() {
    clear
    echo -e "${GREEN}=== System Update ===${NC}"
    echo ""
    
    if ask_yes_no "Update package lists?"; then
        log_action "Updating package lists..."
        apt update 2>&1 | tee -a "$LOG_FILE"
    fi
    
    if ask_yes_no "Upgrade all packages?"; then
        log_action "Upgrading packages..."
        apt upgrade -y 2>&1 | tee -a "$LOG_FILE"
    fi
    
    if ask_yes_no "Perform dist-upgrade?"; then
        log_action "Performing dist-upgrade..."
        apt dist-upgrade -y 2>&1 | tee -a "$LOG_FILE"
    fi
    
    if ask_yes_no "Remove unused packages?"; then
        log_action "Removing unused packages..."
        apt autoremove -y 2>&1 | tee -a "$LOG_FILE"
    fi
    
    if ask_yes_no "Enable automatic security updates?"; then
        log_action "Installing unattended-upgrades..."
        apt install -y unattended-upgrades 2>&1 | tee -a "$LOG_FILE"
        dpkg-reconfigure -plow unattended-upgrades
        log_action "Automatic updates enabled"
    fi
    
    echo -e "${GREEN}System update complete!${NC}"
    pause
}

#################################################################
# 2. USER MANAGEMENT
#################################################################
#################################################################
# 2. USER MANAGEMENT
#################################################################
user_management() {
    clear
    echo -e "${GREEN}=== User Management ===${NC}"
    echo ""
    
    echo "Current users (UID >= 1000):"
    awk -F: '$3 >= 1000 && $1 != "nobody" {print $1 " (UID: " $3 ")"}' /etc/passwd
    echo ""

    echo -e "${BLUE}1) Remove Users${NC}"
    echo -e "${BLUE}2) Manage Administrators (sudo){NC}"
    echo -e "${BLUE}3) Return to Main Menu${NC}"
    echo ""

    read -p "Select an option: " um_choice

    case $um_choice in
        1)
            ###########################################################
            # REMOVE USERS
            ###########################################################
            if ask_yes_no "Review and remove users?"; then
                while true; do
                    read -p "Enter username to remove (or 'done' to finish): " username
                    if [ "$username" = "done" ]; then break; fi
                
                    if id "$username" &>/dev/null; then
                        echo "User $username exists"
                        if ask_yes_no "Remove $username and their home directory?"; then
                            deluser --remove-home "$username" 2>&1 | tee -a "$LOG_FILE"
                            log_action "Removed user: $username"
                        fi
                    else
                        echo "User $username does not exist"
                    fi
                done
            fi
            ;;

        2)
            ###########################################################
            # ADMIN MANAGEMENT (SUDO CONTROL)
            ###########################################################
            clear
            echo -e "${GREEN}=== Administrator Management ===${NC}"
            echo ""

            echo "Current Administrators (sudo group):"
            getent group sudo | awk -F: '{print $4}'
            echo ""

            echo "1) Add user to sudo (make admin)"
            echo "2) Remove user from sudo"
            echo "3) Return"
            echo ""

            read -p "Select an option: " admin_choice

            case $admin_choice in
                1)
                    read -p "Enter username to make administrator: " username
                    if id "$username" &>/dev/null; then
                        usermod -aG sudo "$username"
                        log_action "Added $username to sudo group"
                        echo -e "${GREEN}$username is now an administrator.${NC}"
                    else
                        echo -e "${RED}User does not exist.${NC}"
                    fi
                    ;;
                2)
                    read -p "Enter username to remove from administrators: " username
                    if id "$username" &>/dev/null; then
                        deluser "$username" sudo
                        log_action "Removed $username from sudo group"
                        echo -e "${GREEN}$username is no longer an administrator.${NC}"
                    else
                        echo -e "${RED}User does not exist.${NC}"
                    fi
                    ;;
                *)
                    echo "Returning..."
                    ;;
            esac
            ;;

        3)
            return
            ;;
        *)
            echo -e "${RED}Invalid option.${NC}"
            ;;
    esac

    pause
}

#################################################################
# 3. PASSWORD POLICIES
#################################################################
password_policies() {
    clear
    echo -e "${GREEN}=== Password Policies ===${NC}"
    echo ""
    
    if ask_yes_no "Configure password quality requirements?"; then
        log_action "Installing libpam-pwquality..."
        apt install -y libpam-pwquality 2>&1 | tee -a "$LOG_FILE"
        
        # Backup original
        cp /etc/security/pwquality.conf /etc/security/pwquality.conf.bak
        
        # Set password requirements
        cat > /etc/security/pwquality.conf << EOF
# Password Quality Requirements
minlen = 10
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
minclass = 3
maxrepeat = 2
EOF
        log_action "Password quality requirements set"
        echo -e "${GREEN}Password requirements configured${NC}"
    fi
    
    if ask_yes_no "Configure password aging in /etc/login.defs?"; then
        # Backup original
        cp /etc/login.defs /etc/login.defs.bak
        
        sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs
        sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs
        sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs
        
        log_action "Password aging configured"
        echo -e "${GREEN}Password aging configured${NC}"
    fi
    
    if ask_yes_no "Configure account lockout policy?"; then
        # Check if using faillock or pam_tally2
        if [ -f /usr/sbin/faillock ]; then
            # Modern systems use faillock
            PAM_FILE="/etc/pam.d/common-auth"
            if [ -f "$PAM_FILE" ]; then
                cp "$PAM_FILE" "${PAM_FILE}.bak"
                if ! grep -q "pam_faillock.so" "$PAM_FILE"; then
                    echo "auth required pam_faillock.so preauth deny=5 unlock_time=1800" >> "$PAM_FILE"
                    echo "auth required pam_faillock.so authfail" >> "$PAM_FILE"
                    log_action "Account lockout configured with faillock"
                fi
            fi
        else
            # Older systems use pam_tally2
            apt install -y libpam-modules 2>&1 | tee -a "$LOG_FILE"
            PAM_FILE="/etc/pam.d/common-auth"
            if [ -f "$PAM_FILE" ]; then
                cp "$PAM_FILE" "${PAM_FILE}.bak"
                if ! grep -q "pam_tally2.so" "$PAM_FILE"; then
                    echo "auth required pam_tally2.so deny=5 unlock_time=1800" >> "$PAM_FILE"
                    log_action "Account lockout configured with pam_tally2"
                fi
            fi
        fi
        echo -e "${GREEN}Account lockout configured${NC}"
    fi
    
    if ask_yes_no "Force password change for all users on next login?"; then
        echo "This will require ALL users to change passwords on next login"
        if ask_yes_no "Are you sure?"; then
            for user in $(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd); do
                chage -d 0 "$user"
                log_action "Forced password change for: $user"
            done
            echo -e "${GREEN}Password changes forced${NC}"
        fi
    fi
    
    echo -e "${GREEN}Password policies complete!${NC}"
    pause
}

#################################################################
# 4. SERVICE MANAGEMENT
#################################################################
service_management() {
    clear
    echo -e "${GREEN}=== Service Management ===${NC}"
    echo ""
    
    echo "Running services:"
    systemctl list-units --type=service --state=running --no-pager | grep -v "^â—"
    echo ""
    
    # Common unnecessary services
    SERVICES=("telnet" "rsh" "rlogin" "vsftpd" "pure-ftpd" "apache2" "nginx" "samba" "smbd" "nmbd" "snmpd")
    
    echo "Common services to consider disabling:"
    for service in "${SERVICES[@]}"; do
        if systemctl is-active --quiet "$service" 2>/dev/null; then
            echo -e "${YELLOW}  - $service (running)${NC}"
        fi
    done
    echo ""
    
    if ask_yes_no "Review and disable services?"; then
        while true; do
            read -p "Enter service name to disable (or 'done' to finish): " service_name
            if [ "$service_name" = "done" ]; then
                break
            fi
            
            if systemctl is-active --quiet "$service_name" 2>/dev/null; then
                echo "Service $service_name is running"
                if ask_yes_no "Stop and disable $service_name?"; then
                    systemctl stop "$service_name"
                    systemctl disable "$service_name"
                    log_action "Stopped and disabled: $service_name"
                    echo -e "${GREEN}Service $service_name disabled${NC}"
                fi
            else
                echo "Service $service_name is not running or doesn't exist"
            fi
        done
    fi
    
    echo -e "${GREEN}Service management complete!${NC}"
    pause
}

#################################################################
# 5. FIREWALL CONFIGURATION
#################################################################
firewall_config() {
    clear
    echo -e "${GREEN}=== Firewall Configuration ===${NC}"
    echo ""
    
    if ask_yes_no "Install and configure UFW firewall?"; then
        log_action "Installing UFW..."
        apt install -y ufw 2>&1 | tee -a "$LOG_FILE"
        
        # Set default policies
        ufw default deny incoming
        ufw default allow outgoing
        log_action "UFW default policies set"
        
        echo ""
        echo "Common ports to allow:"
        echo "  22  - SSH"
        echo "  80  - HTTP"
        echo "  443 - HTTPS"
        echo ""
        
        if ask_yes_no "Allow SSH (port 22)?"; then
            ufw allow 22/tcp
            log_action "UFW: Allowed SSH (22/tcp)"
        fi
        
        if ask_yes_no "Allow HTTP (port 80)?"; then
            ufw allow 80/tcp
            log_action "UFW: Allowed HTTP (80/tcp)"
        fi
        
        if ask_yes_no "Allow HTTPS (port 443)?"; then
            ufw allow 443/tcp
            log_action "UFW: Allowed HTTPS (443/tcp)"
        fi
        
        if ask_yes_no "Add custom port?"; then
            while true; do
                read -p "Enter port number (or 'done' to finish): " port
                if [ "$port" = "done" ]; then
                    break
                fi
                read -p "Protocol (tcp/udp): " protocol
                ufw allow "$port/$protocol"
                log_action "UFW: Allowed $port/$protocol"
            done
        fi
        
        if ask_yes_no "Enable UFW now?"; then
            echo "y" | ufw enable
            log_action "UFW enabled"
            ufw status verbose
        fi
        
        echo -e "${GREEN}Firewall configured!${NC}"
    fi
    
    pause
}

#################################################################
# 6. SSH HARDENING
#################################################################
ssh_hardening() {
    clear
    echo -e "${GREEN}=== SSH Hardening ===${NC}"
    echo ""
    
    if [ ! -f /etc/ssh/sshd_config ]; then
        echo -e "${RED}SSH not installed${NC}"
        pause
        return
    fi
    
    if ask_yes_no "Harden SSH configuration?"; then
        # Backup original
        cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%Y%m%d_%H%M%S)
        
        # Apply hardening settings
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
        sed -i 's/^#*PermitEmptyPasswords.*/PermitEmptyPasswords no/' /etc/ssh/sshd_config
        sed -i 's/^#*X11Forwarding.*/X11Forwarding no/' /etc/ssh/sshd_config
        sed -i 's/^#*Protocol.*/Protocol 2/' /etc/ssh/sshd_config
        
        # Add if not present
        if ! grep -q "^MaxAuthTries" /etc/ssh/sshd_config; then
            echo "MaxAuthTries 3" >> /etc/ssh/sshd_config
        fi
        
        log_action "SSH configuration hardened"
        echo -e "${GREEN}SSH hardened${NC}"
        
        if ask_yes_no "Restart SSH service?"; then
            systemctl restart sshd || systemctl restart ssh
            log_action "SSH service restarted"
        fi
    fi
    
    pause
}

#################################################################
# 7. FILE PERMISSIONS & AUDIT
#################################################################
file_permissions() {
    clear
    echo -e "${GREEN}=== File Permissions & Audit ===${NC}"
    echo ""
    
    if ask_yes_no "Fix critical file permissions?"; then
        chmod 644 /etc/passwd
        chmod 640 /etc/shadow
        chmod 644 /etc/group
        chmod 640 /etc/gshadow
        log_action "Fixed critical file permissions"
        echo -e "${GREEN}Critical file permissions fixed${NC}"
    fi
    
    if ask_yes_no "Search for world-writable files? (may take time)"; then
        echo "Searching for world-writable files..."
        find / -xdev -type f -perm -002 ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null | tee /tmp/world_writable.txt
        log_action "World-writable files logged to /tmp/world_writable.txt"
        echo ""
        echo "Results saved to /tmp/world_writable.txt"
    fi
    
    if ask_yes_no "Search for files with no owner? (may take time)"; then
        echo "Searching for files with no owner..."
        find / -xdev \( -nouser -o -nogroup \) ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null | tee /tmp/no_owner.txt
        log_action "Files with no owner logged to /tmp/no_owner.txt"
        echo ""
        echo "Results saved to /tmp/no_owner.txt"
    fi
    
    if ask_yes_no "Search for SUID files? (may take time)"; then
        echo "Searching for SUID files..."
        find / -xdev -type f -perm -4000 ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null | tee /tmp/suid_files.txt
        log_action "SUID files logged to /tmp/suid_files.txt"
        echo ""
        echo "Results saved to /tmp/suid_files.txt"
        echo "Review these carefully before removing SUID bit!"
    fi
    
    echo -e "${GREEN}File permissions audit complete!${NC}"
    pause
}

#################################################################
# 8. FIND PROHIBITED FILES
#################################################################
find_prohibited_files() {
    clear
    echo -e "${GREEN}=== Find Prohibited Files ===${NC}"
    echo ""
    
    echo "Searching for common media files..."
    
    if ask_yes_no "Search for MP3 files?"; then
        find /home -name "*.mp3" 2>/dev/null | tee /tmp/mp3_files.txt
        log_action "MP3 files logged to /tmp/mp3_files.txt"
    fi
    
    if ask_yes_no "Search for MP4/video files?"; then
        find /home -name "*.mp4" -o -name "*.avi" -o -name "*.mov" -o -name "*.mkv" 2>/dev/null | tee /tmp/video_files.txt
        log_action "Video files logged to /tmp/video_files.txt"
    fi
    
    if ask_yes_no "Search for image files?"; then
        find /home -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.gif" 2>/dev/null | tee /tmp/image_files.txt
        log_action "Image files logged to /tmp/image_files.txt"
    fi
    
    if ask_yes_no "Check Downloads and Desktop folders?"; then
        find /home/*/Downloads /home/*/Desktop -type f 2>/dev/null | tee /tmp/downloads_desktop.txt
        log_action "Downloads/Desktop contents logged"
    fi
    
    echo ""
    echo -e "${YELLOW}Review the files above before deleting!${NC}"
    echo "Results saved to /tmp/ for review"
    
    pause
}

#################################################################
# 9. REMOVE COMMON HACKING TOOLS
#################################################################
remove_hacking_tools() {
    clear
    echo -e "${GREEN}=== Remove Common Hacking Tools ===${NC}"
    echo ""
    
    HACKING_TOOLS=("nmap" "wireshark" "john" "hydra" "aircrack-ng" "netcat" "nc" "nikto" "sqlmap" "metasploit-framework")
    
    echo "Common hacking tools to check:"
    for tool in "${HACKING_TOOLS[@]}"; do
        if dpkg -l | grep -q "^ii.*$tool"; then
            echo -e "${YELLOW}  - $tool (installed)${NC}"
        fi
    done
    echo ""
    
    if ask_yes_no "Remove hacking/penetration testing tools?"; then
        for tool in "${HACKING_TOOLS[@]}"; do
            if dpkg -l | grep -q "^ii.*$tool"; then
                if ask_yes_no "Remove $tool?"; then
                    apt purge -y "$tool" 2>&1 | tee -a "$LOG_FILE"
                    log_action "Removed: $tool"
                fi
            fi
        done
        echo -e "${GREEN}Tool removal complete!${NC}"
    fi
    
    pause
}

#################################################################
# 10. KERNEL SECURITY (sysctl)
#################################################################
kernel_security() {
    clear
    echo -e "${GREEN}=== Kernel Security Settings ===${NC}"
    echo ""
    
    if ask_yes_no "Apply kernel hardening settings?"; then
        # Backup original
        cp /etc/sysctl.conf /etc/sysctl.conf.bak
        
        cat >> /etc/sysctl.conf << EOF

# Security Hardening Settings
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
net.ipv4.tcp_syncookies = 1
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
EOF
        
        sysctl -p
        log_action "Kernel security settings applied"
        echo -e "${GREEN}Kernel hardening complete!${NC}"
    fi
    
    pause
}

#################################################################
# 11. INSTALL SECURITY TOOLS
#################################################################
install_security_tools() {
    clear
    echo -e "${GREEN}=== Install Security Tools ===${NC}"
    echo ""
    
    if ask_yes_no "Install fail2ban (intrusion prevention)?"; then
        apt install -y fail2ban 2>&1 | tee -a "$LOG_FILE"
        systemctl enable fail2ban
        systemctl start fail2ban
        log_action "fail2ban installed and started"
    fi
    
    if ask_yes_no "Install rkhunter (rootkit detection)?"; then
        apt install -y rkhunter 2>&1 | tee -a "$LOG_FILE"
        rkhunter --update
        log_action "rkhunter installed"
        echo "Run 'rkhunter --check' to scan for rootkits"
    fi
    
    if ask_yes_no "Install auditd (system auditing)?"; then
        apt install -y auditd 2>&1 | tee -a "$LOG_FILE"
        systemctl enable auditd
        systemctl start auditd
        log_action "auditd installed and started"
    fi
    
    if ask_yes_no "Install aide (file integrity checker)?"; then
        apt install -y aide 2>&1 | tee -a "$LOG_FILE"
        aideinit
        log_action "AIDE installed"
        echo "AIDE database initialized"
    fi
    
    echo -e "${GREEN}Security tools installation complete!${NC}"
    pause
}

#################################################################
# 12. SYSTEM AUDIT REPORT
#################################################################
system_audit() {
    clear
    echo -e "${GREEN}=== System Audit Report ===${NC}"
    echo ""
    
    AUDIT_FILE="/tmp/security_audit_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "=========================================="
        echo "System Security Audit Report"
        echo "Generated: $(date)"
        echo "=========================================="
        echo ""
        
        echo "=== Users with UID >= 1000 ==="
        awk -F: '$3 >= 1000 && $1 != "nobody" {print $1 " (UID: " $3 ")"}' /etc/passwd
        echo ""
        
        echo "=== Sudo Users ==="
        grep -Po '^sudo.+:\K.*$' /etc/group
        echo ""
        
        echo "=== Running Services ==="
        systemctl list-units --type=service --state=running --no-pager --no-legend
        echo ""
        
        echo "=== Listening Ports ==="
        ss -tulpn
        echo ""
        
        echo "=== Firewall Status ==="
        if command -v ufw &> /dev/null; then
            ufw status verbose
        else
            echo "UFW not installed"
        fi
        echo ""
        
        echo "=== Failed Login Attempts (last 20) ==="
        grep "Failed password" /var/log/auth.log 2>/dev/null | tail -20
        echo ""
        
        echo "=== Last System Updates ==="
        grep "upgrade" /var/log/apt/history.log 2>/dev/null | tail -5
        echo ""
        
    } | tee "$AUDIT_FILE"
    
    log_action "System audit report generated: $AUDIT_FILE"
    echo -e "${GREEN}Audit report saved to: $AUDIT_FILE${NC}"
    
    pause
}

#################################################################
# 13. RUN ALL
#################################################################
run_all() {
    echo -e "${YELLOW}Running all hardening steps...${NC}"
    echo ""
    
    update_system
    user_management
    password_policies
    service_management
    firewall_config
    ssh_hardening
    file_permissions
    find_prohibited_files
    remove_hacking_tools
    kernel_security
    install_security_tools
    system_audit
    
    echo -e "${GREEN}All hardening steps complete!${NC}"
    pause
}

#################################################################
# MAIN LOOP
#################################################################
while true; do
    show_menu
    read -p "Select an option: " choice
    
    case $choice in
        1) update_system ;;
        2) user_management ;;
        3) password_policies ;;
        4) service_management ;;
        5) firewall_config ;;
        6) ssh_hardening ;;
        7) file_permissions ;;
        8) find_prohibited_files ;;
        9) remove_hacking_tools ;;
        10) kernel_security ;;
        11) install_security_tools ;;
        12) system_audit ;;
        13) run_all ;;
        0) 
            echo -e "${GREEN}Exiting. Log saved to: $LOG_FILE${NC}"
            exit 0
            ;;
        *) 
            echo -e "${RED}Invalid option${NC}"
            sleep 1
            ;;
    esac
done

